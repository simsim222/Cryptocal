<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í¬ë¦½í†  íˆ¬ì ë§¤ë„ì  ê³„ì‚°ê¸°</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f9f9f9; margin: 40px; }
    h1 { text-align: center; font-size: 35px; font-weight: bold; }
    .timestamp { text-align: center; font-size: 17px; font-weight: bold; margin-bottom: 20px; }
    .top-container { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 20px; }
    .guide { background-color: #fffde7; padding: 10px; border: 1px solid #eee; width: 1100px; font-size: 18px; line-height: 1.8; }
    .info-boxes { display: flex; gap: 10px; margin-top: 130px; margin-left: 70px; }
    .info-box { background-color: #ADD8E633; border: none; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 10px; width: 130px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
    .info-box:nth-child(2) { background-color: rgba(255,0,0,0.1); }
    .info-box p { margin: 0; font-size: 18px; font-weight: bold; text-align: center; }
    .pct-select { margin-top: 10px; padding: 6px; font-size: 18px; border: 1px solid #ccc; border-radius: 4px; width: 55%; background-color: #fafafa; }
    .exchange-select { width: 100px; font-size: 18px; padding: 4px; box-sizing: border-box; }
    .table-wrapper { display: flex; align-items: flex-start; gap: 10px; }
    .suffix { font-weight: normal; font-size: 15px; }
    .table-wrapper input { height: 40px; }
    .left-table { border-collapse: collapse; background-color: white; min-width: 550px; }
    .left-table th:nth-child(2)   { width: 120px; }
    .left-table th:nth-child(3)   { width: 170px; }
    .left-table th:nth-child(5), .left-table th:nth-child(6)   { width: 130px; }
    .left-table th:nth-child(7), .left-table td:nth-child(7)   { width: 90px; }
    .left-table input[type="date"] { font-size: 18px; }
    .right-table { border-collapse: collapse; background-color: white; }
    .right-table th:first-child, .right-table td:first-child  { width: 130px; }
    .right-table th:nth-child(2), .right-table td:nth-child(2)  { width: 90px; }
    .right-table th:nth-child(3), .right-table td:nth-child(3), .right-table th:nth-child(4), .right-table td:nth-child(4)  { width: 135px; }
    .right-table th:nth-child(5), .right-table td:nth-child(5), .right-table th:nth-child(6), .right-table td:nth-child(6)  { width: 60px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; font-size: 18px; }
    th { background-color: #f2f2f2; }
    input { width: 100%; padding: 4px; box-sizing: border-box; font-size: 18px; }
    button.clear-row, button.delete-row { background-color: white; border: none; font-size: 28px; cursor: pointer; padding: 0; line-height: 1; }
    .stop-loss { color: #007bff; }
    .take-profit { color: #e60000; }
    .plus-btn { width: 48px; height: 48px; font-size: 32px; background: #fff; color: #007bff; border: none; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.10); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s, box-shadow 0.2s, color 0.2s; outline: none; }
    .plus-btn:hover, .plus-btn:focus { background: #eaf2ff; box-shadow: 0 4px 12px rgba(0,123,255,0.12); color: #0056b3; }
    .profit { color: #e60000; font-weight: bold; }
    .loss { color: #007bff; font-weight: bold; }
.stop-select,
.profit-select {
  width: 80px !important;
    text-align: center;
}
  
  /* ì…ë ¥ë¶ˆê°€ inputì˜ ë””ìì¸ */
input[readonly] {
  background-color: #f5f5f5 !important; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
  border: 1px solid #ddd !important;   /* ì—°í•œ í…Œë‘ë¦¬ */
  cursor: default !important;
}

input {
  text-align: center;
}
  /* ë§¤ë„ì (ì†ì ˆ) inputì„ ê°•ì¡° - íŒŒë€ìƒ‰ í…Œë§ˆ */
.stop-point {
  color: #007bff !important;
  background: linear-gradient(90deg, #e6f0fb 0%, #f8fcff 100%);
  border: 2px solid #007bff !important;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,123,255,0.09);
  font-size: 20px;
  text-align: center;
  transition: box-shadow 0.2s;
}

/* ë§¤ë„ì (ìµì ˆ) inputì„ ê°•ì¡° - ë¹¨ê°„ìƒ‰ í…Œë§ˆ */
.profit-point {
  color: #e60000 !important;
  background: linear-gradient(90deg, #ffecec 0%, #fff8f8 100%);
  border: 2px solid #e60000 !important;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(230,0,0,0.09);
  font-size: 20px;
  text-align: center;
  transition: box-shadow 0.2s;
}

/* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ ë” ê°•ì¡° */
.stop-point:hover,
.profit-point:hover {
  box-shadow: 0 4px 16px 0 rgba(0,0,0,0.15);
}

  

  </style>


</head>
<body>
  <h1>í¬ë¦½í†  íˆ¬ì ë§¤ë„ì  ê³„ì‚°ê¸°<br>(ì—…ë¹„íŠ¸ ì „ìš©)</h1>
  <div class="timestamp">(ê¸°ì¤€ì‹œì  : yyyy-mm-dd hh:mm)</div>

  <div class="top-container">
    <div class="guide">
      <b>ğŸ“ ë§¤ë„ ëª©í‘œ: <u>ìˆ˜ìµ êµ¬ê°„ ì¤‘ ìƒìŠ¹í•  ë• ê³„ì† ë”°ë¼ ì˜¬ë¼ê°€ë˜, ìµœê³ ì ì—ì„œ ì¼ë¶€ í•˜ë½ ì‹œ ìë™ ë§¤ë„ë¥¼ ëª©í‘œë¡œ í•¨</u></b><br>
      <b>ğŸ“ ì„¤ëª… ë° ì‚¬ìš©ë°©ë²•:</b><br>
      1) ìš°ì¸¡ì˜ ì†ì ˆ/ìµì ˆ êµ¬ê°„ ì„¤ì •<br>
      â€ƒâ€ƒ-(ì†ì‹¤ ì‹œ)<span class="stop-loss">ì†ì ˆ</span>ì  : <b>í‰ë‹¨ê°€ ëŒ€ë¹„ -OO% í•˜ë½ì‹œ</b> ë§¤ë„<br>
      â€ƒâ€ƒ-(ìˆ˜ìµ ì‹œ)<span class="take-profit">ìµì ˆ</span>ì  : ë§¤ìˆ˜ì¼ì~í˜„ì¬ì¼ì ì¤‘ <b>ìµœê³  ìˆ˜ìµë¥  ëŒ€ë¹„ -OO% í•˜ë½ì‹œ</b> ë§¤ë„<br>
      2) í•˜ë‹¨ ì¢Œì¸¡ í‘œì— ê±°ë˜ì†Œ/ì¢…ëª©ëª…/ë§¤ìˆ˜ì¼ì/í‰ê· ë‹¨ê°€ ì…ë ¥ â†’ ì‹¤ì‹œê°„ ê°€ê²©ê³¼ ìˆ˜ìµë¥ Â·ìµœê³ ê°€Â·ë§¤ë„ì  ìë™ ê³„ì‚°<br>
      3) ì‚°ì¶œëœ ë§¤ë„ì ì„ ê±°ë˜ì†Œì— 'ìë™ì£¼ë¬¸'ìœ¼ë¡œ ì…ë ¥(ê°ì‹œê°€, ì£¼ë¬¸ê°€ ë™ì¼) â†’ í•´ë‹¹ ê°€ê²© ë„ë‹¬ì‹œ ì£¼ë¬¸ì´ ë°œë™ë¨
    </div>
    <div class="info-boxes">
      <div class="info-box">
        <p>[<span class="stop-loss">ì†ì ˆ</span> êµ¬ê°„]<br>í‰ê· ë‹¨ê°€ ëŒ€ë¹„</p>
        <select class="pct-select stop-select">
          <option value="-0.05">-5%</option>
          <option value="-0.10">-10%</option>
          <option value="-0.15">-15%</option>
          <option value="-0.20">-20%</option>
          <option value="-0.25">-25%</option>
          <option value="-0.30">-30%</option>
		  <option value="-0.35">-35%</option>
		  <option value="-0.40">-40%</option>
		  <option value="-0.45">-45%</option>
		  <option value="-0.50">-50%</option>
        </select>
      </div>
      <div class="info-box">
        <p>[<span class="take-profit">ìµì ˆ</span> êµ¬ê°„]<br>ìµœê³  ìˆ˜ìµë¥  ëŒ€ë¹„</p>
        <select class="pct-select profit-select">
          <option value="-0.05">-5%</option>
          <option value="-0.10">-10%</option>
          <option value="-0.15">-15%</option>
          <option value="-0.20">-20%</option>
          <option value="-0.25">-25%</option>
          <option value="-0.30">-30%</option>
		  <option value="-0.35">-35%</option>
		  <option value="-0.40">-40%</option>
		  <option value="-0.45">-45%</option>
		  <option value="-0.50">-50%</option>
        </select>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="left-table">
  <thead>
    <tr>
      <th>ìˆœë²ˆ</th>
      <th>ê±°ë˜ì†Œ</th>
      <th>ì¢…ëª©ëª…<br><span class="suffix">
      <th>ë§¤ìˆ˜ì¼ì</th>
      <th>í‰ê· ë‹¨ê°€<br><span class="suffix">(ì›)</span></th>
      <th>í˜„ì¬ê°€ê²©<br><span class="suffix">(ì›)</span></th>
      <th>ìˆ˜ìµë¥ <br><span class="suffix">(%)</span></th>
    </tr>
  </thead>
 <tbody>
  <tr>
    <td>1</td>
    <td>
      <select class="exchange-select">
        <option value="" disabled hidden></option>
        <option value="UPBIT" selected>ì—…ë¹„íŠ¸</option>
      </select>
    </td>
    <td>
      <input type="text" class="symbol-input" list="symbol-list-1" autocomplete="off" disabled>
      <datalist id="symbol-list-1"></datalist>
    </td>
    <td>
      <input type="date" class="buy-date" disabled>
    </td>
    <td>
      <input type="text" class="avg-price" autocomplete="off" disabled>
    </td>
    <td>
      <input type="text" class="cur-price" readonly>
    </td>
    <td>
      <input type="text" class="roi" readonly>
    </td>
  </tr>
</tbody>

</table>

    <table class="right-table">
  <thead>
    <tr>
      <th>ìµœê³ ê°€ê²©<br><span class="suffix">(ì›)</span></th>
      <th>ìµœê³  ìˆ˜ìµë¥ <br><span class="suffix">(%)</span></th>
      <th>ë§¤ë„ì <br>(<span class="stop-loss">ì†ì ˆ</span>)</th>
      <th>ë§¤ë„ì <br>(<span class="take-profit">ìµì ˆ</span>)</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="text" class="high-price" readonly></td>
      <td><input type="text" class="max-roi" readonly></td>
      <td><input type="text" class="stop-point" readonly></td>
      <td><input type="text" class="profit-point" readonly></td>
      <td><button class="clear-row">ğŸ§¹</button></td>
      <td><button class="delete-row">ğŸ—‘ï¸</button></td>
    </tr>
    </tbody>
</table>

  </div>
  <div style="display: flex; justify-content: flex-start; margin: 32px 0;">
    <button id="add-row" class="plus-btn">ï¼‹</button>
  </div>

 <script>
 // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ yyyy-mm-dd í˜•ì‹ìœ¼ë¡œ êµ¬í•˜ê¸°
const now = new Date();
const YYYY = now.getFullYear();
const MM = String(now.getMonth() + 1).padStart(2, '0');
const DD = String(now.getDate()).padStart(2, '0');
const todayStr = `${YYYY}-${MM}-${DD}`;

function setBuyDateMax() {
  document.querySelectorAll('.buy-date').forEach(input => {
    input.setAttribute('max', todayStr);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // ì—…ë¹„íŠ¸ ì¢…ëª©ë¦¬ìŠ¤íŠ¸ë§Œ ì‚¬ìš©
  const marketSymbols = { UPBIT: [] };
  let upbitMarkets = [];

  // ìµì ˆ/ì†ì ˆ êµ¬ê°„ ì„ íƒê°’
  let stopLossVal = parseFloat(document.querySelector('.stop-select').value);
  let takeProfitVal = parseFloat(document.querySelector('.profit-select').value);

  document.querySelector('.stop-select').addEventListener('change', function() {
    stopLossVal = parseFloat(this.value);
    updateAll();
    saveTableData();
  });
  document.querySelector('.profit-select').addEventListener('change', function() {
    takeProfitVal = parseFloat(this.value);
    updateAll();
    saveTableData();
  });

  // ì—…ë¹„íŠ¸ ì¢…ëª© ë¶ˆëŸ¬ì˜¤ê¸° (í‹°ì»¤+í•œê¸€ëª…)
  async function fetchUpbitMarkets() {
    const res = await fetch('https://api.upbit.com/v1/market/all?isDetails=false');
    const data = await res.json();
    marketSymbols.UPBIT = data.filter(m => m.market.startsWith('KRW-'))
      .map(m => ({
        code: m.market.replace('KRW-', ''),
        name: m.korean_name,
        display: `${m.market.replace('KRW-', '')}(${m.korean_name})`
      }));
    upbitMarkets = marketSymbols.UPBIT.map(m => m.code);
  }

  fetchUpbitMarkets().then(updateAllSymbolDatalists);

  function updateAllSymbolDatalists() {
    document.querySelectorAll('.left-table tbody tr').forEach((row, idx) => {
      const exchangeSel = row.querySelector('.exchange-select');
      const datalist = row.querySelector('datalist');
      if (exchangeSel && datalist) {
        setTimeout(() => {
          updateSymbolDatalist(datalist, marketSymbols[exchangeSel.value]);
        }, 200);
        exchangeSel.addEventListener('change', function() {
          updateSymbolDatalist(datalist, marketSymbols[this.value]);
        });
      }
    });
  }

  function updateSymbolDatalist(datalist, symbols) {
    datalist.innerHTML = '';
    if (!symbols) return;
    symbols.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.display;
      datalist.appendChild(opt);
    });
  }

  // â˜…â˜…â˜… ìë™ ê³„ì‚°/ì…ë ¥ í•¨ìˆ˜ ì „ì²´ â˜…â˜…â˜…
  async function updateAll() {
    const leftRows = document.querySelectorAll('.left-table tbody tr');
    const rightRows = document.querySelectorAll('.right-table tbody tr');
    for (let i = 0; i < leftRows.length; i++) {
      const lrow = leftRows[i];
      const rrow = rightRows[i];

      // ì…ë ¥ê°’ ì½ê¸°
      const exchange = lrow.querySelector('.exchange-select').value;
      let symbolStr = lrow.querySelector('.symbol-input').value.trim().toUpperCase();
      if (symbolStr.includes('(')) symbolStr = symbolStr.split('(')[0].trim();
      const buyDate = lrow.querySelector('.buy-date').value;

      let avgPriceRaw = lrow.querySelector('.avg-price').value;
      let avgPrice = avgPriceRaw.replace(/[^0-9.]/g, '');
      let avgPriceNumber = avgPrice ? parseFloat(avgPrice) : null;

      let curPriceRaw = lrow.querySelector('.cur-price').value.replace(/[^0-9.]/g, '');
      let curPrice = curPriceRaw ? parseFloat(curPriceRaw) : null;

      // ì…ë ¥ì´ 4ê°œ ëª¨ë‘ ì—†ìœ¼ë©´ continue
      if (!exchange || !symbolStr || !buyDate || !avgPriceNumber) continue;

      // í‰ê· ë‹¨ê°€ inputì— ì½¤ë§ˆ ì¶”ê°€í•´ì„œ ë³´ì—¬ì£¼ê¸°
      lrow.querySelector('.avg-price').value = avgPrice ? Number(avgPrice).toLocaleString() : '';

      // í˜„ì¬ê°€ê²© (ì—…ë¹„íŠ¸ API)
      if (symbolStr && upbitMarkets.includes(symbolStr)) {
  try {
    // fetch ê²°ê³¼ë¥¼ res ë³€ìˆ˜ì— ë°˜ë“œì‹œ ì €ì¥
    const res = await fetch(`https://cryptocal.muts111zzz.workers.dev/?url=https://api.upbit.com/v1/ticker?markets=KRW-${symbolStr}`);
    const data = await res.json();
    let fetchedPrice = data[0].trade_price;
    lrow.querySelector('.cur-price').value = Number(fetchedPrice).toLocaleString();
    curPrice = fetchedPrice;
  } catch (e) {
    lrow.querySelector('.cur-price').value = '';
  }
}

      // ìˆ˜ìµë¥  ê³„ì‚° (avgPriceNumberë¡œ)
let roi = '';
if (curPrice && avgPriceNumber) {
  roi = ((curPrice - avgPriceNumber) / avgPriceNumber * 100).toFixed(1);
  lrow.querySelector('.roi').value = roi;
} else {
  lrow.querySelector('.roi').value = '';
}

// === ê°’ ì…ë ¥ í›„ í•­ìƒ ìƒ‰ìƒ/êµµê¸° ì ìš© ===
let roiInput = lrow.querySelector('.roi');
if (roiInput && roiInput.value !== '') {
  let roiVal = parseFloat(roiInput.value);
  if (!isNaN(roiVal)) {
    if (roiVal > 0) {
      roiInput.style.color = '#e60000';  // ë¹¨ê°„ìƒ‰
      roiInput.style.fontWeight = 'bold';
    } else if (roiVal < 0) {
      roiInput.style.color = '#007bff';  // íŒŒë€ìƒ‰
      roiInput.style.fontWeight = 'bold';
    } else {
      roiInput.style.color = '#222';     // 0ì´ë©´ ì§„í•œ íšŒìƒ‰
      roiInput.style.fontWeight = 'bold';
    }
  }
} else if (roiInput) {
  roiInput.style.color = '#222';         // ê°’ ì—†ì„ ë•Œ ì§„í•œ íšŒìƒ‰
  roiInput.style.fontWeight = 'bold';
}


      // ìµœê³ ê°€ê²©/ìµœê³ ìˆ˜ìµë¥  (ì—…ë¹„íŠ¸ ìº”ë“¤)
      let highPrice = null;
      let maxRoi = '';
      if (buyDate && symbolStr && upbitMarkets.includes(symbolStr)) {
        try {
          const now = new Date();
          const start = new Date(buyDate);
          const diffDays = Math.ceil((now - start) / (1000 * 60 * 60 * 24)) + 1;
          const count = Math.min(diffDays, 200);

          const toIso = now.toISOString();
const res2 = await fetch(`https://cryptocal.muts111zzz.workers.dev/?url=https://api.upbit.com/v1/candles/days?market=KRW-${symbolStr}&to=${toIso}&count=${count}`);

const candles = await res2.json();

highPrice = candles.reduce((max, c) => Math.max(max, c.high_price), 0);

if (highPrice < avgPriceNumber) {
  rrow.querySelector('.high-price').value = '-';
  rrow.querySelector('.max-roi').value = '-';
} else {
  rrow.querySelector('.high-price').value = Number(highPrice).toLocaleString();
  maxRoi = ((highPrice - avgPriceNumber) / avgPriceNumber * 100).toFixed(1);
  rrow.querySelector('.max-roi').value = maxRoi;
}
		  
		  let maxRoiInput = rrow.querySelector('.max-roi');
if (maxRoiInput && maxRoiInput.value !== '' && maxRoiInput.value !== '-') {
  let maxRoiVal = parseFloat(maxRoiInput.value);
  if (!isNaN(maxRoiVal)) {
    if (maxRoiVal > 0) {
      maxRoiInput.style.color = '#e60000';
      maxRoiInput.style.fontWeight = 'bold';
    } else if (maxRoiVal < 0) {
      maxRoiInput.style.color = '#007bff';
      maxRoiInput.style.fontWeight = 'bold';
    } else {
      maxRoiInput.style.color = '#222';
      maxRoiInput.style.fontWeight = 'bold';
    }
  }
} else if (maxRoiInput) {
  maxRoiInput.style.color = '#222';
  maxRoiInput.style.fontWeight = 'bold';
}
		  
		  
        } catch (e) {
          rrow.querySelector('.high-price').value = '';
          rrow.querySelector('.max-roi').value = '';
        }
      } else {
        rrow.querySelector('.high-price').value = '';
        rrow.querySelector('.max-roi').value = '';
      }

      // === ìµì ˆì (ìµì ˆ) ê³„ì‚° ===
      // maxRoiëŠ” ë¬¸ìì—´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ìˆ«ìë¡œ ë³€í™˜
      let maxRoiNum = maxRoi && maxRoi !== '-' ? parseFloat(maxRoi) : null;
      let absProfitVal = Math.abs(takeProfitVal); // ìµì ˆêµ¬ê°„ ì ˆëŒ€ê°’(ì–‘ìˆ˜)
      let profitPoint = '';

      // ìµœê³  ìˆ˜ìµë¥ (%) > ìµì ˆ êµ¬ê°„ ì ˆëŒ€ê°’(%) ì´ì–´ì•¼ë§Œ ì‘ë™
      if (
  maxRoiNum !== null &&
  !isNaN(maxRoiNum) &&
  avgPriceNumber !== null &&
  !isNaN(avgPriceNumber) &&
  maxRoiNum > (absProfitVal * 100)
) {
  // í‰ê· ë‹¨ê°€ Ã— (1 + (ìµœê³  ìˆ˜ìµë¥ (%) / 100 + ìµì ˆ êµ¬ê°„))
  let profitRate = (maxRoiNum / 100) + takeProfitVal;
  profitPoint = Math.round(avgPriceNumber * (1 + profitRate)).toLocaleString();
} else {
  profitPoint = '';
}

      // ì‹¤ì œ inputì— ì…ë ¥
      rrow.querySelector('.profit-point').value = profitPoint;
	  
	  
	  // === ì†ì ˆì (ì†ì ˆ) ê³„ì‚° ===
// ìµì ˆì ì´ ì—†ì„ ë•Œë§Œ ì‘ë™
let stopPoint = '';
if (!profitPoint && avgPriceNumber !== null && !isNaN(avgPriceNumber)) {
  stopPoint = Math.round(avgPriceNumber * (1 + stopLossVal)).toLocaleString();
} else {
  stopPoint = '';
}
rrow.querySelector('.stop-point').value = stopPoint;

    }
  }

  // ì…ë ¥ê°’ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
  function saveTableData() {
  const leftRows  = Array.from(document.querySelectorAll('.left-table tbody tr'));
  const rightRows = Array.from(document.querySelectorAll('.right-table tbody tr'));
  const data = {
    left: leftRows.map(row =>
      Array.from(row.querySelectorAll('input, select')).map(i => i.value)
    ),
    right: rightRows.map(row =>
      Array.from(row.querySelectorAll('input')).map(i => i.value)
    ),
    stopSelect: document.querySelector('.stop-select').value,     // ì¶”ê°€
    profitSelect: document.querySelector('.profit-select').value  // ì¶”ê°€
  };
  localStorage.setItem('cryptoTableData', JSON.stringify(data));
}


function loadTableData() {
  const json = localStorage.getItem('cryptoTableData');
  if (!json) return;
  const data = JSON.parse(json);

  // === êµ¬ê°„ê°’ ë³µì› ===
  if (data.stopSelect !== undefined) {
    document.querySelector('.stop-select').value = data.stopSelect;
    // ì•„ë˜ë„ ê°±ì‹  í•„ìš”
    stopLossVal = parseFloat(data.stopSelect);
  }
  if (data.profitSelect !== undefined) {
    document.querySelector('.profit-select').value = data.profitSelect;
    takeProfitVal = parseFloat(data.profitSelect);
  }

     const leftTbody = document.querySelector('.left-table tbody');
    while (leftTbody.rows.length < data.left.length) { addNewRow(); }
    while (leftTbody.rows.length > data.left.length) {
      leftTbody.deleteRow(-1);
      document.querySelector('.right-table tbody').deleteRow(-1);
    }
    Array.from(leftTbody.rows).forEach((row, r) => {
      Array.from(row.querySelectorAll('input, select')).forEach((cell, c) => {
        cell.value = data.left[r][c] || '';
      });
    });
    const rightTbody = document.querySelector('.right-table tbody');
    Array.from(rightTbody.rows).forEach((row, r) => {
      Array.from(row.querySelectorAll('input')).forEach((cell, c) => {
        cell.value = data.right[r][c] || '';
      });
    });
    setTimeout(updateAll, 200);
    setTimeout(updateAllSymbolDatalists, 200);
    bindEvents();
  }

  // í–‰ ì¶”ê°€ í•¨ìˆ˜
  function addNewRow() {
    const leftTbody = document.querySelector('.left-table tbody');
    const rightTbody = document.querySelector('.right-table tbody');
    const newIndex = leftTbody.rows.length + 1;
    const leftClone = leftTbody.rows[0].cloneNode(true);
    leftClone.cells[0].textContent = newIndex;
    leftClone.querySelector('.symbol-input').setAttribute('list', 'symbol-list-' + newIndex);
    leftClone.querySelector('datalist').setAttribute('id', 'symbol-list-' + newIndex);
    leftClone.querySelectorAll('input, select').forEach(i => i.value = '');
    // ê±°ë˜ì†ŒëŠ” í•­ìƒ UPBITìœ¼ë¡œ ì´ˆê¸°í™”
    leftClone.querySelector('.exchange-select').value = "UPBIT";
    leftTbody.appendChild(leftClone);

    const rightClone = rightTbody.rows[0].cloneNode(true);
    rightClone.querySelectorAll('input').forEach(i => i.value = '');

    rightClone.querySelector('.clear-row').addEventListener('click', function() {
      if (!confirm('ì´ ì¤„ì˜ ì…ë ¥ê°’ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const idx = Array.from(rightTbody.children).indexOf(this.closest('tr'));
      [leftTbody, rightTbody].forEach(tb => {
        const r = tb.children[idx];
        if (r) r.querySelectorAll('input, select').forEach(i => i.value = '');
      });
      updateAll();
      saveTableData();
    });
    rightClone.querySelector('.delete-row').addEventListener('click', function() {
      if (!confirm('ì´ ì¤„ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const idx = Array.from(rightTbody.children).indexOf(this.closest('tr'));
      if (leftTbody.rows.length <= 1) {
        alert('ìµœì†Œ 1í–‰ì€ ë‚¨ê²¨ë‘ì…”ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      rightTbody.children[idx].remove();
      leftTbody.children[idx]?.remove();
      updateAll();
      saveTableData();
    });

    rightTbody.appendChild(rightClone);
    setTimeout(updateAllSymbolDatalists, 200);
    bindEvents();
	setBuyDateMax();

  }

  document.querySelectorAll('.clear-row').forEach(btn => {
    btn.addEventListener('click', function() {
      if (!confirm('ì´ ì¤„ì˜ ì…ë ¥ê°’ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const leftTbody = document.querySelector('.left-table tbody');
      const rightTbody = document.querySelector('.right-table tbody');
      const idx = Array.from(rightTbody.children).indexOf(this.closest('tr'));
      [leftTbody, rightTbody].forEach(tb => {
        const r = tb.children[idx];
        if (r) r.querySelectorAll('input, select').forEach(i => i.value = '');
      });
      updateAll();
      saveTableData();
    });
  });
  document.querySelectorAll('.delete-row').forEach(btn => {
    btn.addEventListener('click', function() {
      if (!confirm('ì´ ì¤„ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const leftTbody = document.querySelector('.left-table tbody');
      const rightTbody = document.querySelector('.right-table tbody');
      if (leftTbody.rows.length <= 1) {
        alert('ìµœì†Œ 1í–‰ì€ ë‚¨ê²¨ë‘ì…”ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      const idx = Array.from(rightTbody.children).indexOf(this.closest('tr'));
      rightTbody.children[idx].remove();
      leftTbody.children[idx]?.remove();
      updateAll();
      saveTableData();
    });
  });

  document.getElementById('add-row').addEventListener('click', function() {
    addNewRow();
    updateAll();
    saveTableData();
  });

  // ì™¼ìª½ í…Œì´ë¸” ê°’ ë³€ê²½ì‹œ ìë™ê³„ì‚°
  const leftTable = document.querySelector('.left-table');
  leftTable.addEventListener('change', function(e) {
    if (e.target.matches('.exchange-select, .symbol-input, .buy-date, .avg-price, .stop-select, .profit-select')) {
      updateAll();
      saveTableData();
    }
  });

  // ê¸°ì¤€ì‹œì  í‘œì‹œ
  const tsEl = document.querySelector('.timestamp');
  if (tsEl) {
    const now = new Date();
    const YYYY = now.getFullYear();
    const MM   = String(now.getMonth()+1).padStart(2,'0');
    const DD   = String(now.getDate()).padStart(2,'0');
    const hh   = String(now.getHours()).padStart(2,'0');
    const mm   = String(now.getMinutes()).padStart(2,'0');
    tsEl.textContent = `(ê¸°ì¤€ì‹œì  : ${YYYY}-${MM}-${DD} ${hh}:${mm})`;
  }

  function bindEvents() {
    document.querySelectorAll('.left-table tbody tr').forEach((row, idx) => {
      const exchange = row.querySelector('.exchange-select');
      const symbol = row.querySelector('.symbol-input');
      const date = row.querySelector('.buy-date');
      controlInputOrder(row);
      exchange.addEventListener('change', function() { controlInputOrder(row); });
      symbol.addEventListener('input', function() { controlInputOrder(row); });
      date.addEventListener('change', function() { controlInputOrder(row); });
    });
  }

  function controlInputOrder(row) {
    const exchange = row.querySelector('.exchange-select');
    const symbol = row.querySelector('.symbol-input');
    const date = row.querySelector('.buy-date');
    const price = row.querySelector('.avg-price');
    if (!exchange.value) {
      symbol.disabled = true;
      date.disabled = true;
      price.disabled = true;
    } else if (exchange.value && !symbol.value) {
      symbol.disabled = false;
      date.disabled = true;
      price.disabled = true;
    } else if (exchange.value && symbol.value && !date.value) {
      symbol.disabled = false;
      date.disabled = false;
      price.disabled = true;
    } else {
      symbol.disabled = false;
      date.disabled = false;
      price.disabled = false;
    }
  }

  loadTableData();
  bindEvents();
  updateAll();
  setBuyDateMax();

});
</script>

</body>
</html>
